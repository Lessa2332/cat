<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Сліди кота → Кіт з’являється</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body {margin:0;overflow:hidden;background:#000}
    #info {
      position:absolute;top:20px;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,0.75);color:gold;padding:12px 30px;border-radius:30px;
      font-family:sans-serif;font-size:1.1em;z-index:100;pointer-events:none;
    }
    #sound-btn {
      position:absolute;bottom:30px;left:50%;transform:translateX(-50%);
      background:#ff4444;color:white;border:none;padding:16px 32px;
      border-radius:50px;font-size:1.2em;z-index:100;display:none;cursor:pointer;
      font-family:sans-serif;box-shadow:0 8px 20px rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>

  <div id="info">Знайди слід лапки на підлозі</div>
  <button id="sound-btn">Увімкнути звук котика</button>

  <a-scene
    mindar-image="imageTargetSrc: paw.mind; filterMinCF:0.0001; filterBeta:0.001"
    mindar-image-target="targetWidth: 0.148"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
    background="color: #00000000">

    <a-assets timeout="60000">
      <img id="paw-img" src="paw.png">
      <a-asset-item id="cat-model" src="cat.glb"></a-asset-item>
      <audio id="purr" src="cat-meow.mp3" preload="auto"></audio>
    </a-assets>

    <a-camera position="0 1.6 0" look-controls="enabled: false"></a-camera>

    <!-- Тригер — перший слід (А5 маркер) -->
    <a-entity id="trigger" mindar-image-target="targetIndex: 0"></a-entity>

    <!-- Ланцюжок слідів + кіт в кінці -->
    <a-entity id="chain" visible="false">
      <a-image class="paw" src="#paw-img" width="0.22" height="0.22" rotation="-90 0 0" position="0.30 0.01 0" visible="false"></a-image>
      <a-image class="paw" src="#paw-img" width="0.22" height="0.22" rotation="-90 0 0" position="0.60 0.01 0" visible="false"></a-image>
      <a-image class="paw" src="#paw-img" width="0.22" height="0.22" rotation="-90 0 0" position="0.90 0.01 0" visible="false"></a-image>
      <a-image class="paw" src="#paw-img" width="0.22" height="0.22" rotation="-90 0 0" position="1.20 0.01 0" visible="false"></a-image>
      <a-image class="paw" src="#paw-img" width="0.22" height="0.22" rotation="-90 0 0" position="1.50 0.01 0" visible="false"></a-image>

      <!-- Кіт на відстані 2 метри -->
      <a-entity id="cat" position="2.0 0 0" visible="false">
        <a-gltf-model src="#cat-model" scale="0.7 0.7 0.7" animation-mixer></a-gltf-model>
        <a-entity sound="src: #purr; positional: true; refDistance: 0.5; maxDistance: 15; rolloffFactor: 2; loop: true; volume: 1"></a-entity>
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    const sceneEl = document.querySelector('a-scene');
    const chain = document.getElementById('chain');
    const cat = document.getElementById('cat');
    const info = document.getElementById('info');
    const soundBtn = document.getElementById('sound-btn');
    let anchor = null;
    let soundAllowed = false;

    // iOS — звук тільки після тапу
    soundBtn.onclick = () => {
      soundAllowed = true;
      soundBtn.style.display = 'none';
      const dummy = new Audio();
      dummy.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
      dummy.play().catch(()=>{});
    };

    sceneEl.addEventListener('targetFound', e => {
      if (e.target.id !== 'trigger') return;

      anchor = e.target.object3D;
      info.textContent = "Кіт іде по слідах...";

      chain.setAttribute('visible', true);
      chain.object3D.position.copy(anchor.position);
      chain.object3D.quaternion.copy(anchor.quaternion);

      const paws = chain.querySelectorAll('.paw');
      const delay = 750;

      // Напрямок від маркера вперед
      const forward = new THREE.Vector3(0,0,-1);
      forward.applyQuaternion(anchor.quaternion);

      paws.forEach((paw, i) => {
        setTimeout(() => {
          paw.setAttribute('visible', true);
          paw.setAttribute('animation', `property: opacity; from: 0; to: ${0.9-i*0.1}; dur: 700; easing: easeOutCubic`);

          // Слід дивиться в напрямку руху
          const dir = forward.clone();
          paw.object3D.lookAt(paw.object3D.getWorldPosition(new THREE.Vector3()).add(dir));
          paw.object3D.rotation.x = -Math.PI / 2;
        }, i * delay);
      });

      // Кіт після останнього сліду
      setTimeout(() => {
        cat.setAttribute('visible', true);
        cat.setAttribute('animation', 'property: scale; from: 0.01 0.01 0.01; to: 0.7 0.7 0.7; dur: 900; easing: easeOutBack');

        // Кіт дивиться в напрямок останнього сліду
        const lastPos = paws[paws.length-1].object3D.getWorldPosition(new THREE.Vector3());
        cat.object3D.lookAt(lastPos);

        info.textContent = "Мяу! Кіт знайшовся!";
        if (soundAllowed) {
          cat.querySelector('[sound]').components.sound.playSound();
        } else {
          soundBtn.style.display = 'block';
        }
      }, paws.length * delay + 700);
    });

    // При втраті маркера — усе залишається у світі (світ зафіксовано)
 1 раз)
  </script>
</body>
</html>
